AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Resources:
  CustomEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: CustomEventBus
  GetBookingsFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
      SamResourceId: GetBookingsFunction
    Properties:
      CodeUri: GetBookingsFunction
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
      - arm64
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: BookingDynamoDBTable
      - DynamoDBWritePolicy:
          TableName:
            Ref: BookingDynamoDBTable
  BookingDynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: BookingDynamoDBTable
      AttributeDefinitions:
      - AttributeName: BookingId
        AttributeType: S
      KeySchema:
      - AttributeName: BookingId
        KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
  SearchFlightFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
      SamResourceId: SearchFlightFunction
    Properties:
      CodeUri: SearchFlightFunction
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
      - arm64
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: FlightManagementDynamoDBTable
      - DynamoDBWritePolicy:
          TableName:
            Ref: FlightManagementDynamoDBTable
  BookingCRUD:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
      SamResourceId: BookingCRUD
    Properties:
      CodeUri: BookingCRUD
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
      - arm64
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: FlightManagementDynamoDBTable
      - DynamoDBWritePolicy:
          TableName:
            Ref: FlightManagementDynamoDBTable
  FlightManagementDynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: FlightManagementDynamoDBTable
      AttributeDefinitions:
      - AttributeName: FlightId
        AttributeType: S
      KeySchema:
      - AttributeName: FlightId
        KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
  APIGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      DefinitionBody:
        swagger: '2.0'
        info:
          title: APIGateway
        paths:
          /searchFlight:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              parameters: []
              responses: {}
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${SearchFlightFunction.Arn}/invocations
          /getBookings:
            post:
              consumes:
              - application/json
              produces:
              - application/json
              parameters: []
              responses: {}
              x-amazon-apigateway-integration:
                type: aws
                httpMethod: POST
                uri:
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetBookingsFunction.Arn}/invocations
  ConnectedAirlinesUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: ConnectedAirlinesUserPool
      Policies:
        PasswordPolicy:
          RequireLowercase: true
          RequireSymbols: false
          RequireNumbers: true
          MinimumLength: '8'
          RequireUppercase: true
      UsernameAttributes:
      - email
      Schema:
      - AttributeDataType: String
        Name: email
        Required: false
      AutoVerifiedAttributes:
      - email
  ConnectedAirlinesUserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      UserPoolId:
        Ref: ConnectedAirlinesUserPool
      Domain: connectedairlines
  ConnectedAirlinesUserClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId:
        Ref: ConnectedAirlinesUserPool
      ClientName: ConnectedAirlinesUserClient
      GenerateSecret: false
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthFlows:
      - code
      CallbackURLs:
      - https://dev.d3vyzw80s24mm5.amplifyapp.com/Home
      SupportedIdentityProviders:
      - COGNITO
      AllowedOAuthScopes:
      - phone
      - email
      - openid
  APIGatewayPermissionGetBookings:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
        - GetBookingsFunction
        - Arn
      Principal: apigateway.amazonaws.com
  APIGatewayPermissionSearchFlight:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
        - SearchFlightFunction
        - Arn
      Principal: apigateway.amazonaws.com
  EventRule:
    Type: AWS::Events::Rule
    Properties:
      EventBusName:
        Ref: CustomEventBus
      EventPattern:
        source:
        - api.gateway
        detail-type:
        - API Gateway Request
      Targets:
      - Arn:
          Fn::GetAtt:
          - SearchFlightFunction
          - Arn
        Id: InvokeSearchFlightFunction
      - Arn:
          Fn::GetAtt:
          - GetBookingsFunction
          - Arn
        Id: InvokeGetBookingsFunction
